
final String version = "0.1-A"
final String buildDirectory="${project.rootDir}/jme3-alloc/build/classes/java/main/"
final String nativeObjects="${project.rootDir}/jme3-alloc-native/build/"

task copyNatives(type: Copy) {
    from "${nativeObjects}"
    into "${buildDirectory}"
}

tasks.register("prepareOutputDirectory", UnixScript) {
   script = "./helper-scripts/prepare-output-directory.sh"
}

tasks.register("compileX86", UnixScript) {
   dependsOn("prepareOutputDirectory")
   script = "./helper-scripts/compile-x86.sh"
}

tasks.register("compileX86_64", UnixScript) {
   dependsOn("prepareOutputDirectory")
   script = "./helper-scripts/compile-x86-64.sh"
}

abstract class UnixScript extends DefaultTask {
    @Input
    abstract Property<String> getScript()

    @TaskAction
    def execute() {
        String command = "bash";
        String[] chmod = new String[] { "chmod", "+rwx" };
        String system = System.getProperty("os.name");
        
        if (system.equals("Windows")) {
            command += ".exe";
        } 
        
        /* execute the shell script in a unix process that inheirt from the current environment */
        Process permissioning = Runtime.getRuntime().exec(new String[] { chmod[0], chmod[1], script.get() });

        while (permissioning.getInputStream().read() == 0); /* block until the terminal output is received */
        
        permissioning.destroy(); 
        permissioning = null;
        
        Process run = Runtime.getRuntime().exec(new String[] { command, script.get() });
        
        while (run.getInputStream().read() == 0); /* block until the terminal output (Process input) is received */
        
        run.destroy();
        run = null;
        command = null;
        chmod = null;
        system = null;
    }
}
